## BSGame游戏SDK总体机制
## 1、概述 
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;接入BSGame游戏平台涉及游戏开发的客户端和服务端两部分：客户端部分主要实现了用户登录、注册和充值功能；服务端部分主要包括了access_token管理的接口。
## 2、总体机制说明
### 2.1、总体架构
游戏 SDK”分为“SDK 客户端” （集成于游戏中） 、 “SDK 服务器”两部分。  
“游戏客户端” （内含“SDK 客户端” ） 、 “游戏服务器” 、 “SDK 服务器”之间的关系，如下图所示：  
![总体架构](../img/总体架构.png) 
### 2.2、登录机制
![登录机制](../img/登录机制.png)   

登录流程说明：  
(1)“游戏客户端”调用“SDK 客户端”的登录功能， “SDK 客户端”引导用户输入用户名密码，当用户使用“BSGame账号”登录时， “SDK 客户端”调用“SDK 服务器 ”接口进行身份验证;  
(2)“SDK 服务器”密码验证通过后返回 access_key及用户相关信息(包括：uid、用户昵称等);  
(3)“游戏客户端”在“SDK 客户端”回调通知后，可向“SDK 客户端”获取  access_key;  
(4)“游戏客户端”根据游戏的逻辑需要可将 access_key传给“游戏服务器” ;  
(5)“游戏服务器”可向“SDK 服务器”请求验证  access_key
(调用用户会话验证接口，详见《BSGame游戏 SDK 开发参考说明书-服务器接口》);  
(6)“SDK 服务器”将access_key的验证结果和对应的 uid返回给“游戏服务器”;  
(7)“游戏服务器”将access_key的验证结果及 uid、用户昵称返回给“游戏客户端”。  
### 2.3、充值机制
![充值机制](../img/充值机制.png) 
**支付流程说明：**  
(1)“游戏客户端”调用“SDK 客户端”API 接口，提交充值信息；“SDK 客户端”引导用户选择不同的充值方式，输入充值金额。  
(2)“SDK 客户端”将 access_key、gameid、serverid 以及对应的充值信息提交给“SDK服务器” ；  
(3)“SDK 服务器”接收充值请求后，将充值结果及对应订单号返回给“SDK客户端”；  
(4)“SDK 客户端”将回调通知“游戏客户端”对应的充值“订单号” ；  
(5)“游戏客户端”将接收到的“订单号”及相关的游戏角色信息（由游戏自行决定 ）提交给“游戏服务器” ，游戏服务端需要验证该结果的有效性；  
(6)“SDK 服务器”在处理完充值请求后，将通过异步方式通知“游戏服务器”充值结果。  
(7)“游戏服务器”向“SDK 服务器”返回是否成功接收充值结果的标志（success或 failure） 。充值结果的成功或失败与此处的接收标志无关，不论充值是否成功，只要“游戏服务器”能够接收并识别充值结果通知，都应该向”SDK 服务器“返回成功标志（success） 。  
(8)“游戏客户端”查询“游戏服务器”的订单结果，游戏服务器会到“SDK服务器”进行结果校验，确保结果  
>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第一步游戏客户端在提交充值信息给到SDK-Client时，需要附带由游戏服务器创建的CP订单号，即out_trade_no，该订单号需要游戏客户端提交请求到游戏服务器进行创建，并由游戏服务器进行维护。  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当“SDK服务器”异步告知“游戏服务器”结果时，“游戏服务器”需要进行签名验证该通知的可靠性，同时也要校验返回结果中的充值信息（包括充值uid、金额、单号等信息）是否吻合，只有当吻合才能进行发货处理。
## 3、游戏接入步骤
![游戏接入步骤](../img/游戏接入流程.jpg) 

